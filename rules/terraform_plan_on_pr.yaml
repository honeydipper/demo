---
rules:
  - when:
      source:
        system: github
        trigger: pull_request
    do:
      type: parallel
      content:
        - type: if
          condition: '{{ eq .event.json.repository.fullname "honeydipper/infrastructure-demo" }}'
          content:
            - content: pipe
              data:
                on_error: final
                steps:
                  - name: create commit status msg
                    work:
                      type: function
                      content:
                        target:
                          system: github
                          function: createStatus
                      data:
                        status:
                          state: pending
                          description: Honeydipper is running tf plan...
                          context: honeydipper/tf-plan
                  - name: run tf plan
                    work:
                      content: tf_plan
                      data:
                        system: job_runner
                  - name: send plan output to PR comment
                    work:
                      type: function
                      content:
                        target:
                          system: github
                          function: createComment
                      data:
                        message: '{{ values (index (values .data.log) 0) | join "\n" }}'
                  - name: finalize commit status
                    work:
                      type: function
                      content:
                        target:
                          system: github
                          function: createStatus
                      data:
                        status:
                          state: '{{ `{{ empty .wfdata.step | ternary "success" "failure" }}` }}'
                          description: Honeydipper tf plan {{ `{{ empty .wfdata.step | ternary "succeeded" "failed" }}` }}
                          context: honeydipper/tf-plan
